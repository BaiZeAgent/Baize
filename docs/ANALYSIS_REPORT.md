# 白泽3.0 代码分析报告

**版本**: 3.0.4  
**日期**: 2025-02-25  
**分析范围**: 思考引擎、转换工具、技能系统、执行器

---

## 一、思考引擎分析

### 1.1 发现的硬编码问题

| 位置 | 硬编码内容 | 问题 |
|-----|-----------|------|
| `engine.ts:195-205` | 简单对话判断规则 | 硬编码了问候语、感谢等关键词列表 |
| `engine.ts:296-304` | 技能选择规则 | 硬编码了"文件操作使用 file 或 fs 技能"等规则 |
| `engine.ts:405` | 超时时间 `300000` | 硬编码的 5 分钟超时 |
| `engine.ts:407-410` | 重试策略 | 硬编码的重试次数和延迟 |

### 1.2 架构符合性问题

| 问题 | 架构要求 | 实际情况 | 严重程度 |
|-----|---------|---------|---------|
| 提示词硬编码 | 思考引擎不应硬编码 | 提示词中包含具体技能名称 | 高 |
| 参数未验证 | LLM 输出应验证 | 未验证 params 是否符合 schema | 高 |
| 无参数过滤 | 应按 schema 过滤 | 直接传递 LLM 生成的 params | 高 |

### 1.3 问题根源

```typescript
// engine.ts:287-288
"params": {"参数名": "参数值"},

// 问题：LLM 可能生成 schema 中未定义的参数
// 当前代码没有过滤，直接传递给技能
```

---

## 二、转换工具分析

### 2.1 设计问题

| 问题 | 说明 |
|-----|------|
| **非确定性** | 使用 LLM 生成代码，每次结果不同 |
| **无验证** | 生成的代码没有语法验证 |
| **参数不匹配** | 生成的代码参数可能与 schema 不一致 |
| **依赖 LLM** | 完全依赖 LLM 能力，不可控 |

### 2.2 架构冲突

```
架构要求：
- 技能应该有明确的实现文件
- 执行应该是确定性的

转换工具：
- 动态生成代码
- 结果不可预测
```

### 2.3 建议

**放弃 LLM 转换器**，采用以下方案：

1. **要求技能有实现文件**：main.js / main.py
2. **确定性转换**：仅对简单 curl 命令使用正则解析
3. **拒绝无实现的技能**：提示用户联系技能作者

---

## 三、技能系统分析

### 3.1 执行流程

```
用户输入
    ↓
思考引擎 (LLM 拆解任务)
    ↓
生成 params (可能包含错误参数)
    ↓
执行器调用技能
    ↓
技能执行 (收到错误参数)
    ↓
输出混乱
```

### 3.2 问题点

| 位置 | 问题 |
|-----|------|
| `loader.ts:130-180` | 执行技能时未过滤参数 |
| `executor.ts:413-416` | 参数验证只检查必需参数，未检查额外参数 |
| `engine.ts:320-331` | 直接使用 LLM 返回的 params，未过滤 |

### 3.3 架构要求 vs 实际

| 架构要求 | 实际实现 | 状态 |
|---------|---------|------|
| 技能定义 input_schema | ✓ 已实现 | 符合 |
| 参数验证 | 部分实现 | 不完整 |
| 参数过滤 | ✗ 未实现 | 缺失 |
| 错误处理 | ✓ 已实现 | 符合 |

---

## 四、与 OpenClaw/ClawHub 的对比

### 4.1 技能定义格式

| 项目 | 格式 | 说明 |
|-----|------|------|
| 白泽 | SKILL.md (YAML frontmatter) | 自定义格式 |
| ClawHub | 类似 MCP 格式 | 标准化格式 |

### 4.2 技能调用方式

**白泽**:
```
用户输入 → 思考引擎(LLM) → 生成 params → 调用技能
```

**ClawHub/OpenClaw**:
```
用户输入 → 直接匹配技能 → 调用技能
```

### 4.3 关键区别

| 方面 | 白泽 | ClawHub |
|-----|------|---------|
| 参数生成 | LLM 动态生成 | 用户/系统提供 |
| 参数验证 | 弱 | 强 (schema 严格验证) |
| 技能发现 | LLM 选择 | 关键词/能力匹配 |
| 错误处理 | 有 | 有 |

### 4.4 ClawHub 的优势

1. **参数确定性**：参数由调用方提供，不依赖 LLM 生成
2. **严格验证**：按 schema 验证所有参数
3. **拒绝额外参数**：不接受 schema 未定义的参数

---

## 五、问题总结

### 5.1 核心问题

```
问题链条：

1. 思考引擎使用 LLM 生成 params
         ↓
2. LLM 可能生成 schema 中未定义的参数
         ↓
3. 执行器未过滤额外参数
         ↓
4. 技能收到错误参数
         ↓
5. 输出混乱或错误
```

### 5.2 硬编码问题清单

| 文件 | 行号 | 内容 | 建议 |
|-----|------|------|------|
| engine.ts | 195-205 | 简单对话规则 | 移到配置文件 |
| engine.ts | 296-304 | 技能选择规则 | 移到提示词模板 |
| engine.ts | 405 | 超时时间 | 移到配置文件 |
| engine.ts | 407-410 | 重试策略 | 移到配置文件 |
| executor.ts | 283-299 | 后处理判断规则 | 移到配置文件 |

### 5.3 缺失功能

| 功能 | 架构要求 | 状态 |
|-----|---------|------|
| 参数过滤 | 应过滤额外参数 | 未实现 |
| 提示词模板 | 应可配置 | 硬编码 |
| 技能配置 | 应可配置 | 部分实现 |

---

## 六、修复建议

### 6.1 思考引擎修复

**不使用硬编码，而是让 LLM 正确理解 schema**：

```typescript
// 在 decompose 的提示词中添加：

## 参数规则
对于每个技能，只能使用其 input_schema 中定义的参数。
不要添加 schema 中未定义的参数。

示例：
技能 weather 的 input_schema:
{
  "properties": {
    "location": { "type": "string", "description": "城市名称" }
  }
}

正确: { "skillName": "weather", "params": { "location": "北京" } }
错误: { "skillName": "weather", "params": { "location": "北京", "format": "xxx" } }
// format 不在 schema 中，不要添加
```

### 6.2 执行器修复

**添加参数过滤（非硬编码，基于 schema）**：

```typescript
// 在 executeTask 中添加

// 过滤参数，只保留 schema 中定义的
if (skill.inputSchema?.properties) {
  const filteredParams: Record<string, unknown> = {};
  for (const key of Object.keys(skill.inputSchema.properties)) {
    if (task.params[key] !== undefined) {
      filteredParams[key] = task.params[key];
    }
  }
  task.params = filteredParams;
}
```

### 6.3 转换工具修复

**放弃 LLM 转换，采用确定性方案**：

1. 检查是否有 main.js / main.py
2. 如果没有，检查是否是简单 curl 命令
3. 如果是简单 curl，使用正则解析生成代码
4. 如果无法处理，提示用户"技能不完整"

---

## 七、优先级排序

| 优先级 | 问题 | 影响 |
|-------|------|------|
| P0 | 参数过滤缺失 | 导致技能调用失败 |
| P0 | 提示词未约束参数 | LLM 生成错误参数 |
| P1 | 硬编码配置 | 难以维护 |
| P2 | 转换工具不稳定 | 安装技能失败 |

---

## 八、下一步行动

1. **确认修复方案**
   - 思考引擎：优化提示词，不硬编码
   - 执行器：添加基于 schema 的参数过滤
   - 转换工具：放弃 LLM 转换

2. **讨论点**
   - 参数过滤是否应该在思考引擎还是执行器？
   - 转换工具是否完全放弃，还是保留确定性转换？
   - 提示词模板如何管理？

---

**报告结束**

*请确认后开始修复*
