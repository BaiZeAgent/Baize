# 更新日志 (Changelog)

所有重要的更改都将记录在此文件中。

## [3.1.0] - 2025-02-25

### 重大更新

#### 双层决策机制（智能路由）

基于 OpenClaw 优势，实现快速响应：

1. **智能路由器**
   - 单次 LLM 调用判断任务复杂度
   - 简单任务走快速路径（直接回复/单工具调用）
   - 复杂任务走规划路径（六阶段思考）
   - 不硬编码规则，让 LLM 自己判断

2. **快速路径**
   - 简单对话：直接回复，响应时间 < 500ms
   - 单工具调用：直接执行，响应时间 < 2s

3. **规划路径**
   - 复杂任务：六阶段思考（理解→拆解→规划→调度→验收→反思）
   - 可解释性强，风险可控

#### 执行器集成锁机制

解决并行任务资源冲突问题：

1. **资源锁管理器**
   - 读锁共享，写锁互斥
   - 自动识别任务所需资源
   - 锁等待超时机制

2. **并行执行保护**
   - 并行任务自动获取资源锁
   - 防止文件/网络资源冲突
   - 任务完成后自动释放锁

#### 上下文自动压缩

解决长对话上下文溢出问题：

1. **三层防御机制**
   - 第一层：自动压缩历史消息为摘要
   - 第二层：工具结果智能截断
   - 第三层：友好降级提示

2. **压缩策略**
   - 保留最近 4 轮对话
   - 保留关键决策和工具调用
   - 历史消息压缩为摘要

#### 错误自动恢复

提高系统可靠性：

1. **错误分类**
   - 认证错误、速率限制、网络错误、超时等

2. **恢复策略**
   - Profile 轮换（多 API Key 支持）
   - 指数退避重试
   - 友好错误提示

### 架构改进

```
用户输入
    │
    ▼
┌─────────────────────────────────────────┐
│         智能路由器（单次LLM调用）         │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐ │
│  │  reply  │  │  tool   │  │  plan   │ │
│  │直接回复 │  │单工具   │  │六阶段   │ │
│  └─────────┘  └─────────┘  └─────────┘ │
└─────────────────────────────────────────┘
         │            │            │
    快速路径       快速路径      规划路径
    < 500ms       < 2s         完整思考
```

### 新增模块

| 模块 | 路径 | 功能 |
|-----|------|------|
| 智能路由器 | `core/router` | 双层决策机制 |
| 上下文管理器 | `core/context` | 自动压缩与溢出处理 |
| 错误恢复管理器 | `core/recovery` | 自动恢复与降级处理 |

### 兼容性

- ✅ 完全兼容 v3.0.x 接口
- ✅ 旧功能不受影响
- ✅ 锁机制向后兼容

---

## [3.0.4] - 2025-02-24

### 新增功能

#### 平台相关命令自动转换为跨平台 Node.js

安装 ClawHub 技能时，自动检测并转换平台相关命令：

1. **检测需要转换的技能**
   - 检查是否有 main.js/main.py（有则跳过）
   - 检查是否有 curl 命令
   - 检查是否有 shell 脚本

2. **LLM 自动转换**
   - 分析 curl/shell 命令
   - 生成跨平台的 Node.js 代码
   - 使用 Node.js 原生 fetch API
   - 完善的错误处理和超时控制

3. **转换流程**
   ```
   安装技能
       ↓
   检测平台相关命令
       ↓
   LLM 分析命令和参数
       ↓
   生成 main.js
       ↓
   写入技能目录
   ```

#### 文档型技能使用 Node.js 原生 fetch

- 替代 curl 命令，跨平台兼容
- 添加 curl 作为备选方案
- Windows 兼容性改进

### 修复问题

- Windows 环境下 curl 命令不可用
- ZIP 下载重定向处理
- YAML 解析冒号问题

### 架构改进

#### 技能类型统一

| 类型 | 执行方式 | 跨平台 | 处理 |
|-----|---------|--------|------|
| Python 技能 | python main.py | ✅ | 保持不变 |
| JavaScript 技能 | node main.js | ✅ | 保持不变 |
| 文档型技能 | Node.js fetch | ✅ | 自动转换 |
| Shell 脚本 | bash run.sh | ❌ | 转换为 Node.js |

---

## [3.0.3] - 2025-02-24

### 新增功能

#### LLM 后处理功能
- 技能执行后，LLM 根据记忆和经验自动优化回复
- 支持用户明确指令（"总结一下"、"显示原始结果"）
- 根据结果复杂度自动判断是否需要处理
- 根据用户偏好调整回复风格（简洁/详细）

#### ClawHub 技能安装增强
- **脚本分析**: 分析所有脚本文件（.js, .ts, .py, .sh），不仅仅是 main.js
- **参数提取**: LLM 从脚本代码中提取参数（命令行参数、函数参数）
- **自动安装依赖**: 
  - 检测 `package.json` → 自动执行 `npm install`
  - 检测 `requirements.txt` → 自动执行 `pip install`
- **自动初始化**: 从 Setup 部分提取命令并执行
- **环境变量提示**: 提取并提示需要配置的环境变量

### 修复问题

- 修复文档型技能（如 weather）参数传递问题
- 支持多种参数名（query, city, location 等）
- 从用户输入中智能提取城市名
- 改进错误日志输出

### 架构改进

#### 执行器 (Executor)
```
技能执行结果
    ↓
用户有明确指令？
    ↓ 是 → 执行用户指令
    ↓ 否
结果复杂度判断
    ↓ 简单 → 直接返回
    ↓ 复杂 → LLM处理
    ↓
LLM（带记忆和经验）
    ↓
最终回复
```

#### ClawHub 安装流程
```
1. 下载 ZIP 包
2. 解析所有文件
3. 收集脚本内容
4. LLM 分析文档 + 脚本
5. 提取 input_schema
6. 检测平台相关命令
7. LLM 转换为 Node.js（如需要）
8. 写入文件
9. 安装依赖
10. 执行初始化命令
11. 提示环境变量配置
```

---

## [3.0.2] - 2025-02-23

### 新增功能

- 集成 ClawHub 技能市场
- 支持从 ClawHub 搜索和安装技能
- 自动转换 ClawHub 格式为白泽格式

### 技能系统

- 支持文档型技能（从 SKILL.md 提取 curl 命令执行）
- 支持脚本型技能（JavaScript/Python）
- 技能加载器重构

---

## [3.0.1] - 2025-02-22

### 新增功能

- 六阶段思考协议
- 三层记忆系统
- 自进化系统
- 多 LLM 支持（阿里云百炼、智谱清言、Ollama）

---

## [3.0.0] - 2025-02-20

### 重大更新

- 白泽 3.0 架构重构
- 九层架构设计
- 模块化设计

---

## 版本说明

- **主版本号**: 重大架构变更
- **次版本号**: 新增功能
- **修订号**: Bug 修复和小改进
