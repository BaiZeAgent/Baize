# 更新日志 (Changelog)

所有重要的更改都将记录在此文件中。

## [3.1.1] - 2025-02-25

### 重大更新

#### Docker沙箱隔离

实现安全的代码执行环境：

1. **容器生命周期管理**
   - 创建/启动/停止/销毁容器
   - 自动清理资源

2. **文件系统隔离**
   - 只读挂载系统目录
   - 读写挂载工作目录
   - 禁止挂载敏感目录

3. **网络隔离**
   - 默认无网络访问
   - 可配置bridge/host模式

4. **资源限制**
   - CPU限制：2核
   - 内存限制：2GB
   - PIDs限制：256

5. **安全策略**
   - 禁止特权容器
   - 移除所有能力
   - 超时自动终止

#### 进程管理器

支持后台执行和进程控制：

1. **执行模式**
   - 前台执行：等待完成
   - 后台执行：立即返回ID
   - PTY交互：实时交互

2. **进程控制**
   - 启动/停止/查询状态
   - 超时控制
   - 输出流处理

3. **沙箱集成**
   - 在沙箱中执行命令
   - 主机执行后备方案

#### 向量搜索

实现语义检索能力：

1. **文本嵌入**
   - LLM嵌入支持
   - 哈希嵌入后备

2. **向量存储**
   - 内存存储
   - 文件持久化

3. **相似度搜索**
   - 余弦相似度计算
   - 元数据过滤
   - 分页查询

#### 子Agent支持

实现并行任务处理：

1. **子Agent类型**
   - 同步子Agent：等待完成
   - 异步子Agent：并行执行
   - 独立子Agent：完全独立

2. **任务管理**
   - 任务分发
   - 结果收集
   - 状态监控

3. **资源隔离**
   - 独立沙箱
   - 独立上下文

### 架构改进

```
┌─────────────────────────────────────────────────────────────┐
│                    完整架构                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  用户输入                                                   │
│      │                                                      │
│      ▼                                                      │
│  智能路由器 ──→ 快速路径（reply/tool）                       │
│      │                                                      │
│      ▼                                                      │
│  六阶段思考                                                  │
│      │                                                      │
│      ▼                                                      │
│  子Agent管理器 ──→ 并行执行                                  │
│      │                                                      │
│      ▼                                                      │
│  执行器（带锁保护）                                          │
│      │                                                      │
│      ▼                                                      │
│  沙箱管理器 ──→ Docker容器隔离                               │
│      │                                                      │
│      ▼                                                      │
│  进程管理器 ──→ 前台/后台执行                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 新增模块

| 模块 | 路径 | 功能 |
|-----|------|------|
| 沙箱管理器 | `sandbox/manager.ts` | Docker容器隔离 |
| 进程管理器 | `executor/process.ts` | 后台执行与进程控制 |
| 向量搜索 | `memory/vector.ts` | 语义检索 |
| 子Agent管理器 | `executor/subagent.ts` | 并行任务处理 |

### 兼容性

- ✅ 完全兼容 v3.1.0 接口
- ✅ 旧功能不受影响
- ✅ 沙箱可配置启用/禁用

---

## [3.1.0] - 2025-02-25

### 重大更新

#### 双层决策机制（智能路由）

基于 OpenClaw 优势，实现快速响应：

1. **智能路由器**
   - 单次 LLM 调用判断任务复杂度
   - 简单任务走快速路径（直接回复/单工具调用）
   - 复杂任务走规划路径（六阶段思考）
   - 不硬编码规则，让 LLM 自己判断

2. **快速路径**
   - 简单对话：直接回复，响应时间 < 500ms
   - 单工具调用：直接执行，响应时间 < 2s

3. **规划路径**
   - 复杂任务：六阶段思考（理解→拆解→规划→调度→验收→反思）
   - 可解释性强，风险可控

#### 执行器集成锁机制

解决并行任务资源冲突问题：

1. **资源锁管理器**
   - 读锁共享，写锁互斥
   - 自动识别任务所需资源
   - 锁等待超时机制

2. **并行执行保护**
   - 并行任务自动获取资源锁
   - 防止文件/网络资源冲突
   - 任务完成后自动释放锁

#### 上下文自动压缩

解决长对话上下文溢出问题：

1. **三层防御机制**
   - 第一层：自动压缩历史消息为摘要
   - 第二层：工具结果智能截断
   - 第三层：友好降级提示

2. **压缩策略**
   - 保留最近 4 轮对话
   - 保留关键决策和工具调用
   - 历史消息压缩为摘要

#### 错误自动恢复

提高系统可靠性：

1. **错误分类**
   - 认证错误、速率限制、网络错误、超时等

2. **恢复策略**
   - Profile 轮换（多 API Key 支持）
   - 指数退避重试
   - 友好错误提示

### 架构改进

```
用户输入
    │
    ▼
┌─────────────────────────────────────────┐
│         智能路由器（单次LLM调用）         │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐ │
│  │  reply  │  │  tool   │  │  plan   │ │
│  │直接回复 │  │单工具   │  │六阶段   │ │
│  └─────────┘  └─────────┘  └─────────┘ │
└─────────────────────────────────────────┘
         │            │            │
    快速路径       快速路径      规划路径
    < 500ms       < 2s         完整思考
```

### 新增模块

| 模块 | 路径 | 功能 |
|-----|------|------|
| 智能路由器 | `core/router` | 双层决策机制 |
| 上下文管理器 | `core/context` | 自动压缩与溢出处理 |
| 错误恢复管理器 | `core/recovery` | 自动恢复与降级处理 |

### 兼容性

- ✅ 完全兼容 v3.0.x 接口
- ✅ 旧功能不受影响
- ✅ 锁机制向后兼容

---

## [3.0.4] - 2025-02-24

### 新增功能

#### 平台相关命令自动转换为跨平台 Node.js

安装 ClawHub 技能时，自动检测并转换平台相关命令：

1. **检测需要转换的技能**
   - 检查是否有 main.js/main.py（有则跳过）
   - 检查是否有 curl 命令
   - 检查是否有 shell 脚本

2. **LLM 自动转换**
   - 分析 curl/shell 命令
   - 生成跨平台的 Node.js 代码
   - 使用 Node.js 原生 fetch API
   - 完善的错误处理和超时控制

#### 文档型技能使用 Node.js 原生 fetch

- 替代 curl 命令，跨平台兼容
- 添加 curl 作为备选方案
- Windows 兼容性改进

### 修复问题

- Windows 环境下 curl 命令不可用
- ZIP 下载重定向处理
- YAML 解析冒号问题

---

## [3.0.3] - 2025-02-24

### 新增功能

#### LLM 后处理功能
- 技能执行后，LLM 根据记忆和经验自动优化回复
- 支持用户明确指令（"总结一下"、"显示原始结果"）
- 根据结果复杂度自动判断是否需要处理
- 根据用户偏好调整回复风格（简洁/详细）

#### ClawHub 技能安装增强
- 脚本分析、参数提取、自动安装依赖

---

## [3.0.2] - 2025-02-23

### 新增功能

- 集成 ClawHub 技能市场
- 支持从 ClawHub 搜索和安装技能

---

## [3.0.1] - 2025-02-22

### 新增功能

- 六阶段思考协议
- 三层记忆系统
- 自进化系统
- 多 LLM 支持

---

## [3.0.0] - 2025-02-20

### 重大更新

- 白泽 3.0 架构重构
- 九层架构设计
- 模块化设计

---

## 版本说明

- **主版本号**: 重大架构变更
- **次版本号**: 新增功能
- **修订号**: Bug 修复和小改进
